<!doctype html>
<html lang="ka">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>სეტის დუელი — 61 ქულამდე • მატჩი 11-მდე</title>
  <style>
    :root{
      --bg:#0f5c3a;
      --text:#eaf7ef;
      --muted:#b8e2c8;
      --gold:#fbbf24;
      --card:#ffffff;
      --ink:#111827;
      --shadow: 0 10px 30px rgba(0,0,0,.25);
      --radius: 18px;

      /* ✅ Player1 fixed ზონის სიმაღლე */
      --p1-fixed-h: 210px;
      --p1-fixed-h-mobile: 250px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background: radial-gradient(1200px 700px at 50% 30%, #167a4e 0%, var(--bg) 55%, #0a3a26 100%);
      color:var(--text);
      height:100vh;
      overflow:hidden; /* ✅ გვერდი აღარ ისქროლებს */
    }

    header{
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:space-between;
      padding:12px 14px;
      background: rgba(0,0,0,.15);
      backdrop-filter: blur(8px);
      border-bottom: 1px solid rgba(255,255,255,.08);
      position: sticky;
      top: 0;
      z-index: 80;
    }
    .title{display:flex; align-items:center; gap:10px; min-width:0}
    .title h1{
      margin:0; font-size:15px;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
      max-width: 52vw;
    }

    .controls{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    button{
      appearance:none; border:0; cursor:pointer;
      padding:10px 12px;
      border-radius: 999px;
      background: rgba(255,255,255,.12);
      color:var(--text);
      font-weight:800;
      box-shadow: 0 6px 18px rgba(0,0,0,.15);
      transition: transform .08s ease, background .12s ease, opacity .12s ease;
      user-select:none;
      line-height: 1;
    }
    button:hover{background: rgba(255,255,255,.16)}
    button:active{transform: translateY(1px)}
    button.primary{background: rgba(251,191,36,.22); border: 1px solid rgba(251,191,36,.35)}
    button.primary:hover{background: rgba(251,191,36,.28)}
    button:disabled{opacity:.5; cursor:not-allowed}

    .pill{
      padding:8px 10px;
      border-radius: 999px;
      background: rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.08);
      font-size:12px;
      color:var(--muted);
      display:flex; gap:8px; align-items:center;
      white-space:nowrap;
    }
    .pill b{color:var(--text)}

    main{
      height: calc(100vh - 58px);
      display:flex;
      gap:12px;
      padding:12px;
      padding-bottom: calc(var(--p1-fixed-h) + 14px); /* ✅ ადგილი fixed ხელისთვის */
      overflow:hidden; /* ✅ main არ ისქროლებს */
    }

    .board{
      flex: 1;
      background: rgba(0,0,0,.14);
      border: 1px solid rgba(255,255,255,.08);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      position:relative;
      overflow:auto; /* ✅ ბორდი შიგნით თუ საჭიროა */
      -webkit-overflow-scrolling: touch;
      min-height:0;
    }

    .side{
      width: 360px;
      background: rgba(0,0,0,.14);
      border: 1px solid rgba(255,255,255,.08);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding:12px;
      display:flex;
      flex-direction:column;
      gap:10px;
      min-height:0;
      overflow:hidden;
    }
    .log{
      flex:1;
      background: rgba(0,0,0,.18);
      border: 1px solid rgba(255,255,255,.06);
      border-radius: 14px;
      padding:10px;
      overflow:auto; /* ✅ მხოლოდ ლოგი ისქროლებს */
      font-size:12px;
      color: var(--muted);
      line-height:1.45;
    }
    .log .line{margin: 0 0 6px}

    .table{
      position:relative;
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      grid-template-rows: 140px 1fr;
      gap: 12px;
      padding: 12px;
      min-height:0;
    }

    .zone{
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.10);
      padding:12px;
      display:flex;
      flex-direction:column;
      gap:10px;
      min-height:0;
    }
    .zone .label{
      display:flex;
      justify-content:space-between;
      align-items:center;
      font-size:13px;
      color: var(--muted);
    }
    .zone .label b{color:var(--text)}
    .handRow{
      display:flex;
      gap:12px;
      align-items:center;
      overflow:auto;
      padding:6px 2px 2px;
      min-height:0;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
    }
    .handRow::-webkit-scrollbar{display:none}

    .center{
      grid-column: 2 / 3;
      grid-row: 2 / 3;
      display:flex;
      flex-direction:column;
      gap:10px;
      align-items:center;
      justify-content:center;
      border-radius: 24px;
      background: rgba(0,0,0,.12);
      border: 2px solid rgba(11,61,42,.6);
      box-shadow: inset 0 0 0 2px rgba(255,255,255,.05);
      padding: 10px;
      min-height:0;
    }

    .midTop{display:flex; gap:12px; align-items:center; justify-content:center; flex-wrap:wrap;}
    .deckBox{
      display:flex; align-items:center; gap:10px;
      padding:10px 12px;
      border-radius:16px;
      background: rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.08);
    }
    .deckStack{
      width:50px; height:70px;
      border-radius: 12px;
      background: linear-gradient(135deg, #1e3a8a, #0b1220);
      border: 2px solid rgba(255,255,255,.18);
      box-shadow: 0 10px 22px rgba(0,0,0,.35);
      display:flex; align-items:center; justify-content:center;
      font-weight:900;
    }
    .deckMeta{font-size:12px; color:var(--muted); line-height:1.25}

    .trumpCardMini{
      width: 60px; height: 86px;
      border-radius: 14px;
      background: white;
      color:#111827;
      border:2px solid rgba(17,24,39,.14);
      box-shadow: 0 10px 22px rgba(0,0,0,.25);
      display:flex; flex-direction:column; justify-content:space-between;
      padding:8px;
      position:relative;
    }
    .trumpCardMini::after{
      content:"კოზირი";
      position:absolute; top:-10px; right:-10px;
      background: rgba(251,191,36,.95);
      color:#1f2937;
      font-weight:900;
      font-size:10px;
      padding:6px 8px;
      border-radius:999px;
      border:1px solid rgba(0,0,0,.12);
      box-shadow: 0 10px 22px rgba(0,0,0,.25);
    }
    .trumpCardMini .tTop{display:flex; justify-content:space-between; font-weight:900; font-size:12px}
    .trumpCardMini .tMid{display:flex; align-items:center; justify-content:center; flex:1; font-size:22px; font-weight:900}

    .trickArea{
      width: 100%;
      display:flex;
      gap: 14px;
      justify-content:center;
      align-items:flex-start;
      flex-wrap:wrap;
      padding: 8px;
      min-height:0;
    }
    .stack{display:flex; flex-direction:column; gap:8px; align-items:center; min-width: 180px;}
    .stackTitle{font-size:12px; color: var(--muted); text-align:center;}
    .stackCards{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      justify-content:center;
      min-height: 110px;
      align-items:center;
    }

    .centerInfo{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:center;
      font-size:12px;
      color: var(--muted);
    }
    .badge{
      padding:8px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      display:flex; gap:8px; align-items:center;
      white-space:nowrap;
    }
    .badge b{color:var(--text)}
    .actions{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      justify-content:center;
      margin-top: 6px;
    }

    .card{
      width: 86px;
      height: 126px;
      border-radius: 16px;
      background: var(--card);
      color: var(--ink);
      box-shadow: 0 8px 18px rgba(0,0,0,.25);
      border: 2px solid rgba(17,24,39,.14);
      display:flex;
      flex-direction:column;
      justify-content:space-between;
      padding:10px;
      position:relative;
      flex: 0 0 auto;
      user-select:none;
      transition: transform .12s ease, box-shadow .12s ease, outline .12s ease, opacity .12s ease;
    }
    .card .top{display:flex; justify-content:space-between; font-weight:900; font-size:13px}
    .card .mid{display:flex; flex-direction:column; align-items:center; justify-content:center; gap:3px; flex:1; font-weight:900; font-size:20px}
    .card .pts{font-size:12px; opacity:.7; text-align:center; padding-bottom:2px; font-weight:900;}
    .card.red{color:#b91c1c}
    .card.back{
      background: linear-gradient(135deg, #1e3a8a, #0b1220);
      color:#fff;
      border:2px solid rgba(255,255,255,.18);
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:26px;
      font-weight:900;
    }
    .card.selectable{cursor:pointer}
    .card.selected{
      outline: 3px solid rgba(251,191,36,.75);
      transform: translateY(-4px);
      box-shadow: 0 14px 34px rgba(251,191,36,.12), 0 10px 20px rgba(0,0,0,.25);
    }
    .card.trumpBadge::after{
      content:"კოზირი";
      position:absolute;
      top:-8px; right:-8px;
      background: rgba(251,191,36,.95);
      color:#1f2937;
      font-weight:900;
      font-size:10px;
      padding:6px 8px;
      border-radius:999px;
      border:1px solid rgba(0,0,0,.12);
      box-shadow: 0 10px 22px rgba(0,0,0,.25);
    }

    /* ✅ Player 1 fixed ბარი — სულ ეკრანზე ჩანს */
    .p1Fixed{
      position: fixed;
      left: 12px;
      right: 12px;
      bottom: 12px;
      z-index: 90;
      height: var(--p1-fixed-h);
      border-radius: 20px;
      background: rgba(0,0,0,.50);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,.18);
      box-shadow: 0 -14px 30px rgba(0,0,0,.35);
      padding: 14px 12px 12px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .p1Fixed .label{
      display:flex;
      justify-content:space-between;
      align-items:center;
      font-size:14px;
      color: var(--muted);
    }
    .p1Fixed .label b{color:var(--text)}
    .p1Fixed .handRow{gap:14px; padding: 8px 2px 2px}

    /* წესების / შეთავაზების მოდალი */
    .modalBackdrop{
      position: fixed; inset:0;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 18px;
      z-index: 120;
    }
    .modal{
      width: min(640px, 100%);
      background: rgba(15, 33, 24, .98);
      border:1px solid rgba(255,255,255,.10);
      border-radius: 20px;
      box-shadow: 0 20px 50px rgba(0,0,0,.45);
      padding: 14px;
    }
    .modal h2{margin: 6px 6px 10px; font-size: 16px}
    .modal p{margin: 0 6px 10px; color: var(--muted); font-size: 13px; line-height: 1.45}
    .modal .row{display:flex; gap:8px; flex-wrap:wrap; padding: 6px}
    .modal .row button{flex: 1 0 auto}

    /* ===== ტელეფონი ===== */
    @media (max-width: 820px) {
      :root{ --p1-fixed-h: var(--p1-fixed-h-mobile); }

      header{flex-direction:column; align-items:flex-start; gap:10px;}
      .title h1{max-width: 92vw;}
      .controls{width:100%; gap:8px;}

      main{
        height: calc(100vh - 92px);
        padding:10px;
        padding-bottom: calc(var(--p1-fixed-h) + 14px);
        flex-direction:column;
        gap:10px;
      }

      .side{
        width:100%;
        height: 160px;
        min-height: 160px;
      }

      .board{width:100%}

      .table{
        grid-template-columns: 1fr;
        grid-template-rows: auto auto;
        gap: 10px;
        padding: 10px;
      }
      .zone{grid-column:1 / -1 !important;}
      .center{grid-column:1 / -1 !important; grid-row:auto !important; padding: 8px;}
      .trickArea{padding:4px;}
      .stackCards{min-height:72px;}
      .stack{min-width: 150px;}

      .card{width: 92px; height: 134px;}
      .card .mid{font-size:22px;}
      .deckStack{width:44px; height:62px;}
      .trumpCardMini{width:56px; height:80px;}

      .p1Fixed{
        left: 10px;
        right: 10px;
        bottom: 10px;
        padding: 14px 12px 14px;
      }
    }
  </style>
</head>

<body>
<header>
  <div class="title">
    <h1>სეტის დუელი — 61 ქულამდე • მატჩი 11-მდე</h1>
    <button id="infoBtn" title="წესები">ℹ წესები</button>
  </div>

  <div class="controls">
    <button class="primary" id="new">ახალი მატჩი</button>
    <button id="reset">გადატვირთვა</button>
    <div class="pill"><span>კოზირი:</span> <b id="trumpPill">—</b></div>
    <div class="pill"><span>გემბანი:</span> <b id="deckPill">—</b></div>
    <div class="pill"><span>საფასური:</span> <b id="stakePill">1×</b></div>
    <div class="pill"><span>მატჩი:</span> <b id="matchPill">0–0</b></div>
    <div class="pill"><span>სვლა:</span> <b id="turnPill">—</b></div>
  </div>
</header>

<main>
  <section class="board">
    <div class="table">
      <div class="zone" style="grid-column:1/4; grid-row:1/2;">
        <div class="label"><b>მოთამაშე 2</b><span id="p2Meta"></span></div>
        <div class="handRow" id="p2Hand"></div>
      </div>

      <div class="center">
        <div class="midTop">
          <div class="deckBox">
            <div class="deckStack">★</div>
            <div class="deckMeta">
              <div><b>გემბანი</b></div>
              <div><span id="deckMetaText">—</span></div>
            </div>
          </div>
          <div class="trumpCardMini" id="trumpMini" aria-label="კოზირი">
            <div class="tTop"><span id="trMiniRank">A</span><span id="trMiniSuit">♦</span></div>
            <div class="tMid" id="trMiniMid">♦</div>
          </div>
        </div>

        <div class="trickArea">
          <div class="stack">
            <div class="stackTitle">მოთამაშე 2 დადო</div>
            <div class="stackCards" id="p2Play"></div>
          </div>
          <div class="stack">
            <div class="stackTitle">მოთამაშე 1 დადო</div>
            <div class="stackCards" id="p1Play"></div>
          </div>
        </div>

        <div class="centerInfo">
          <div class="badge"><span>ლიდერი</span> <b id="leaderPill">—</b></div>
          <div class="badge"><span>საჭიროა</span> <b id="needCountPill">—</b></div>
          <div class="badge"><span>სტატუსი</span> <b id="statusPill">დააჭირე “ახალი მატჩი”</b></div>
        </div>

        <div class="actions">
          <button id="playBtn" class="primary" disabled>მონიშნულის დადება</button>
          <button id="clearBtn" disabled>მონიშვნის მოხსნა</button>
          <button id="offerBtn" disabled>შეთავაზება 2×..5× / მთელი</button>
        </div>
      </div>
    </div>
  </section>

  <aside class="side">
    <div class="log" id="log"></div>
  </aside>
</main>

<!-- ✅ Player1 fixed ზონა — სულ ჩანს, სკროლი აღარ გჭირდება -->
<div class="p1Fixed">
  <div class="label"><b>მოთამაშე 1 (შენ)</b><span id="p1Meta"></span></div>
  <div class="handRow" id="p1Hand"></div>
</div>

<!-- წესების მოდალი -->
<div class="modalBackdrop" id="rulesModal" role="dialog" aria-modal="true">
  <div class="modal">
    <h2>წესები</h2>
    <p><b>სეტის დუელი — 61 ქულამდე • მატჩი 11-მდე</b></p>
    <p>• გემბანი: <b>36</b> ბარათი. 5+5 დარიგების შემდეგ რჩება <b>26</b> (36 − 10 = 26).</p>
    <p>• ლიდერი თამაშობს 1–5 ბარათს ერთნაირი ტიპით: <b>ყველა ერთ მასტში</b> ან <b>ყველა ერთ რანკში</b>.</p>
    <p>• პასუხი თამაშობს იგივე რაოდენობას — ნებისმიერი კომბინაციით.</p>
    <p>• P2-ის დადებული ბარათები ჩანს <b>3 წამით</b>.</p>
    <p>• ყოველი გაცვლის შემდეგ ავტომატურად ივსება ხელები 5-მდე (თუ გემბანში არის).</p>
    <p>• თამაში მთავრდება როცა ვინმე მიაღწევს <b>61</b>-ს; <b>60–60</b> არის ფრე.</p>
    <p>• მატჩი: ვინც პირველი მოიგებს <b>11</b> თამაშს.</p>
    <div class="row">
      <button id="rulesClose" class="primary">დახურვა</button>
    </div>
  </div>
</div>

<!-- Offer modal -->
<div class="modalBackdrop" id="offerModal">
  <div class="modal">
    <h2 id="offerTitle">შეთავაზება</h2>
    <p id="offerText"></p>
    <div class="row" id="offerButtons"></div>
    <div class="row">
      <button id="offerClose">დახურვა</button>
    </div>
  </div>
</div>

<script>
/* ===== წესები / მონაცემები ===== */
const TOTAL_DECK = 36;
const RANKS = ["6","7","8","9","Jack","Queen","King","10","Ace"];
const SUITS = ["Hearts","Diamonds","Clubs","Spades"];
const SUIT_SYMBOL = {Hearts:"♥", Diamonds:"♦", Clubs:"♣", Spades:"♠"};
const POINTS = {Ace:11, "10":10, King:4, Queen:3, Jack:2, "9":0, "8":0, "7":0, "6":0};
const STRENGTH = {Ace:8, "10":7, King:6, Queen:5, Jack:4, "9":3, "8":2, "7":1, "6":0};
const GAME_TARGET = 61;

const RAISES = [2,3,4,5,"WHOLE"];
const $ = (id)=>document.getElementById(id);
const isRed = (s)=> s==="Hearts"||s==="Diamonds";

function raiseLabel(x){ return x==="WHOLE" ? "მთელი თამაში" : `${x}×`; }
function stakeText(level){ return level==="WHOLE" ? "მთელი" : `${level}×`; }
function setText(id, value){ const el = $(id); if(el) el.textContent = value; }

function logLine(t){
  const d=document.createElement("div");
  d.className="line";
  d.textContent=t;
  $("log").prepend(d);
}
function shuffle(a){
  for(let i=a.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [a[i],a[j]]=[a[j],a[i]];
  }
  return a;
}
function buildDeck(){
  const d=[];
  for(const s of SUITS) for(const r of RANKS) d.push({r,s});
  return shuffle(d);
}
function sortHand(hand, trump){
  const suitOrder={Hearts:0, Diamonds:1, Clubs:2, Spades:3};
  hand.sort((a,b)=>{
    const ta = a.s===trump ? 1 : 0;
    const tb = b.s===trump ? 1 : 0;
    if(ta!==tb) return tb-ta;
    const ds=suitOrder[a.s]-suitOrder[b.s];
    if(ds!==0) return ds;
    return STRENGTH[b.r]-STRENGTH[a.r];
  });
  return hand;
}
function cardEl(card, {faceUp=true, selectable=false, selected=false, trump=null, onClick=null}={}){
  const d=document.createElement("div");
  d.className="card";

  if(!faceUp){
    d.classList.add("back");
    d.textContent="★";
    return d;
  }

  if(isRed(card.s)) d.classList.add("red");
  if(trump && card.s===trump) d.classList.add("trumpBadge");
  if(selectable) d.classList.add("selectable");
  if(selected) d.classList.add("selected");

  const top=document.createElement("div");
  top.className="top";
  top.innerHTML=`<span>${card.r}</span><span>${SUIT_SYMBOL[card.s]}</span>`;

  const mid=document.createElement("div");
  mid.className="mid";
  mid.innerHTML=`<div style="font-size:24px">${SUIT_SYMBOL[card.s]}</div><div>${card.r}</div>`;

  const pts=document.createElement("div");
  pts.className="pts";
  pts.textContent=`${POINTS[card.r]} ქულა`;

  d.append(top,mid,pts);
  if(selectable && onClick) d.addEventListener("click", onClick);
  return d;
}

/* ===== მდგომარეობა ===== */
const state = {
  matchWins: [0,0],
  gamePoints: [0,0],
  stake: 1,
  trump: null,
  deck: [],
  hands: [[],[]],
  leader: 0,
  turn: 0,
  phase: "idle",
  needCount: 0,
  plays: [[],[]],
  selectedIdxs: new Set(),
  pendingOffer: null,
  nextRaisePlayer: null,
  lockInput: false
};

function resetExchange(){
  state.needCount = 0;
  state.plays = [[],[]];
  state.selectedIdxs.clear();
}

function classifySameKind(cards){
  if(cards.length===0) return null;
  const allRank = cards.every(c=>c.r===cards[0].r);
  const allSuit = cards.every(c=>c.s===cards[0].s);
  if(allRank) return {type:"rank", value:cards[0].r};
  if(allSuit) return {type:"suit", value:cards[0].s};
  return null;
}
function bestCardInSet(set){
  return set.reduce((best,c)=>{
    const tb = best.s===state.trump ? 1 : 0;
    const tc = c.s===state.trump ? 1 : 0;
    if(tc!==tb) return tc>tb ? c : best;
    if(STRENGTH[c.r]!==STRENGTH[best.r]) return STRENGTH[c.r] > STRENGTH[best.r] ? c : best;
    return best;
  }, set[0]);
}
function exchangeWinner(){
  const s1=state.plays[0], s2=state.plays[1];
  const b1=bestCardInSet(s1);
  const b2=bestCardInSet(s2);

  const t1 = b1.s===state.trump ? 1 : 0;
  const t2 = b2.s===state.trump ? 1 : 0;
  if(t1!==t2) return t1>t2 ? 0 : 1;

  if(STRENGTH[b1.r]!==STRENGTH[b2.r]) return STRENGTH[b1.r] > STRENGTH[b2.r] ? 0 : 1;
  return state.leader;
}
function pointsOfSet(set){ return set.reduce((s,c)=>s + (POINTS[c.r] ?? 0), 0); }

function dealUpToFive(winner){
  const order = winner===0 ? [0,1] : [1,0];
  for(const p of order){
    while(state.hands[p].length < 5 && state.deck.length > 0){
      state.hands[p].push(state.deck.pop());
    }
  }
  sortHand(state.hands[0], state.trump);
  sortHand(state.hands[1], state.trump);
}

function updateTopPills(){
  setText("trumpPill", state.trump ? `${state.trump} ${SUIT_SYMBOL[state.trump]}` : "—");
  const deckText = state.phase==="idle" ? "—" : `${state.deck.length} / ${TOTAL_DECK}`;
  setText("deckPill", deckText);
  setText("deckMetaText", state.phase==="idle" ? "—" : `${state.deck.length} დარჩა (სულ ${TOTAL_DECK}-დან)`);
  setText("stakePill", stakeText(state.stake));
  setText("matchPill", `${state.matchWins[0]}–${state.matchWins[1]}`);
  setText("turnPill", (state.phase==="playing"||state.phase==="revealPause") ? `მოთამაშე ${state.turn+1}` : "—");
  setText("leaderPill", (state.phase==="playing"||state.phase==="revealPause") ? `მოთამაშე ${state.leader+1}` : "—");
  setText("needCountPill", state.needCount===0 ? "—" : `${state.needCount}`);

  if(state.trump){
    const sym = SUIT_SYMBOL[state.trump];
    setText("trMiniRank", "A");
    setText("trMiniSuit", sym);
    setText("trMiniMid", sym);
    $("trumpMini").style.opacity = "1";
  } else $("trumpMini").style.opacity = ".3";
}

function renderHands(){
  $("p2Hand").innerHTML="";
  for(let i=0;i<state.hands[1].length;i++){
    $("p2Hand").append(cardEl({r:"",s:"Spades"},{faceUp:false}));
  }

  $("p1Hand").innerHTML="";
  state.hands[0].forEach((c,idx)=>{
    const selected = state.selectedIdxs.has(idx);
    const selectable = (state.phase==="playing" && state.turn===0 && !state.lockInput && !state.pendingOffer);
    $("p1Hand").append(cardEl(c,{
      faceUp:true,
      selectable,
      selected,
      trump: state.trump,
      onClick: ()=>toggleSelect(idx)
    }));
  });

  setText("p1Meta", `ბარათები: ${state.hands[0].length}`);
  setText("p2Meta", `ბარათები: ${state.hands[1].length}`);
}

function renderPlays(){
  $("p1Play").innerHTML="";
  $("p2Play").innerHTML="";
  for(const c of state.plays[0]) $("p1Play").append(cardEl(c,{faceUp:true,trump:state.trump}));
  for(const c of state.plays[1]) $("p2Play").append(cardEl(c,{faceUp:true,trump:state.trump}));
}

function renderControls(){
  const humanTurn = (state.phase==="playing" && state.turn===0 && !state.lockInput && !state.pendingOffer);
  $("playBtn").disabled = !humanTurn;
  $("clearBtn").disabled = !humanTurn;

  let offerEnabled = (state.phase==="playing" && state.turn===0 && !state.lockInput && !state.pendingOffer);
  if(state.nextRaisePlayer !== null && state.nextRaisePlayer !== 0) offerEnabled = false;
  $("offerBtn").disabled = !offerEnabled;
}

function render(){
  updateTopPills();
  renderHands();
  renderPlays();
  renderControls();
}

/* ===== არჩევა ===== */
function toggleSelect(idx){
  if(!(state.phase==="playing" && state.turn===0) || state.lockInput || state.pendingOffer) return;
  if(state.selectedIdxs.has(idx)) state.selectedIdxs.delete(idx);
  else state.selectedIdxs.add(idx);
  if(state.selectedIdxs.size > 5) state.selectedIdxs.delete(idx);
  render();
}
function clearSelection(){
  state.selectedIdxs.clear();
  render();
}
function applyPlay(player, idxs){
  idxs.sort((a,b)=>b-a).forEach(i=> state.hands[player].splice(i,1));
  sortHand(state.hands[player], state.trump);
}

/* ===== Player 1 ===== */
function humanPlaySelected(){
  if(!(state.phase==="playing" && state.turn===0) || state.lockInput || state.pendingOffer) return;

  const idxs=[...state.selectedIdxs].sort((a,b)=>a-b);
  if(idxs.length===0) return;
  const cards = idxs.map(i=>state.hands[0][i]);

  if(state.needCount===0){
    const cls = classifySameKind(cards);
    if(!cls){
      logLine("არასწორია: ლიდერმა უნდა დადოს ერთნაირი ტიპით (ერთი მასტი ან ერთი რანკი).");
      return;
    }
    state.needCount = cards.length;
    state.leader = 0;
  } else {
    if(cards.length !== state.needCount){
      logLine(`უნდა დადოთ ზუსტად ${state.needCount} ბარათი.`);
      return;
    }
  }

  state.plays[0] = cards;
  applyPlay(0, idxs);
  state.selectedIdxs.clear();
  logLine(`მოთამაშე 1-მა დადო ${cards.length} ბარათი.`);
  nextTurn();
}

/* ===== AI ===== */
function aiLeaderMove(){
  const hand = state.hands[1];
  const bySuit = new Map();
  const byRank = new Map();
  hand.forEach((c,idx)=>{
    if(!bySuit.has(c.s)) bySuit.set(c.s,[]);
    bySuit.get(c.s).push(idx);
    if(!byRank.has(c.r)) byRank.set(c.r,[]);
    byRank.get(c.r).push(idx);
  });

  const candidates = [];
  for(const [s,arr] of bySuit.entries()){
    for(let k=Math.min(5,arr.length); k>=1; k--){
      candidates.push({idxs: arr.slice(0,k), score: (s===state.trump?100:0) + k*10});
    }
  }
  for(const [r,arr] of byRank.entries()){
    for(let k=Math.min(5,arr.length); k>=2; k--){
      candidates.push({idxs: arr.slice(0,k), score: k*9});
    }
  }
  if(candidates.length===0) candidates.push({idxs:[0], score:1});
  candidates.sort((a,b)=>b.score-a.score);
  return candidates[0].idxs;
}
function aiResponderMove(){
  const hand = state.hands[1];
  const need = state.needCount;
  const idxs = hand.map((_,i)=>i);

  idxs.sort((i,j)=>{
    const a=hand[i], b=hand[j];
    const ta = a.s===state.trump ? 1 : 0;
    const tb = b.s===state.trump ? 1 : 0;
    if(ta!==tb) return ta - tb;
    return STRENGTH[a.r] - STRENGTH[b.r];
  });

  return idxs.slice(0, Math.min(need, idxs.length));
}

function aiPlay(){
  if(!(state.phase==="playing" && state.turn===1) || state.lockInput || state.pendingOffer) return;
  maybeAiRaise();

  let idxs;
  if(state.needCount===0){
    idxs = aiLeaderMove();
    state.needCount = idxs.length;
    state.leader = 1;
  } else {
    idxs = aiResponderMove();
    if(idxs.length !== state.needCount){
      idxs = state.hands[1].map((_,i)=>i).slice(0,state.needCount);
    }
  }

  const cards = idxs.map(i=>state.hands[1][i]);
  state.plays[1] = cards;
  applyPlay(1, idxs);

  logLine(`მოთამაშე 2-მა დადო ${cards.length} ბარათი. ჩანს 3 წამით…`);

  state.lockInput = true;
  state.phase = "revealPause";
  setText("statusPill","მოთამაშე 2-ის ბარათები ჩანს…");
  render();

  setTimeout(()=>{
    state.lockInput = false;
    state.phase = "playing";
    nextTurn(true);
  }, 3000);
}

/* ===== Flow ===== */
function nextTurn(){
  if(state.plays[0].length && state.plays[1].length){
    resolveExchange();
    return;
  }
  state.turn = 1 - state.turn;
  setText("statusPill", state.turn===0 ? "შენი სვლაა" : "მოთამაშე 2 ფიქრობს…");
  render();
  if(state.turn===1) setTimeout(aiPlay, 500);
}

function resolveExchange(){
  const winner = exchangeWinner();
  const totalPts = pointsOfSet(state.plays[0]) + pointsOfSet(state.plays[1]);
  state.gamePoints[winner] += totalPts;
  logLine(`გაცვლის გამარჯვებულია: მოთამაშე ${winner+1} (+${totalPts}).`);

  state.leader = winner;
  state.turn = winner;

  resetExchange();
  dealUpToFive(winner);

  render();
  if(checkGameEnd()) return;

  setText("statusPill", `შემდეგი გაცვლა. ლიდერი: მოთამაშე ${state.leader+1}`);
  render();
  if(state.turn===1) setTimeout(aiPlay, 500);
}

function checkGameEnd(){
  const p1 = state.gamePoints[0], p2 = state.gamePoints[1];

  if(p1 === 60 && p2 === 60){
    logLine("ფრე — 60–60. მატჩის ქულა არ დაემატება.");
    endGameDraw();
    return true;
  }
  if(p1 >= GAME_TARGET || p2 >= GAME_TARGET){
    if(p1 === p2){
      logLine("ფრე — 61+ თანაბარია (იშვიათი).");
      endGameDraw();
      return true;
    }
    const winner = (p1 > p2) ? 0 : 1;
    endGameWin(winner, "61+ ქულა");
    return true;
  }
  if(state.deck.length === 0 && state.hands[0].length === 0 && state.hands[1].length === 0){
    if(p1 === p2){
      logLine("ფრე — გემბანი დამთავრდა და ქულა თანაბარია.");
      endGameDraw();
      return true;
    }
    const winner = (p1 > p2) ? 0 : 1;
    endGameWin(winner, "გემბანი დამთავრდა");
    return true;
  }
  return false;
}

function endGameDraw(){
  state.phase = "resolve";
  setText("statusPill","თამაში დასრულდა: ფრე (60–60)");
  render();
  setTimeout(startNewGame, 900);
}
function endGameWin(winner, reason){
  state.phase = "resolve";
  logLine(`თამაში დასრულდა — მოიგო მოთამაშე ${winner+1} (${reason}). საფასური: ${stakeText(state.stake)}.`);

  if(state.stake === "WHOLE") state.matchWins[winner] = 11;
  else state.matchWins[winner] += state.stake;

  state.matchWins[winner] = Math.min(11, state.matchWins[winner]);

  setText("statusPill",`თამაში დასრულდა — მოიგო მოთამაშე ${winner+1}`);
  render();

  if(state.matchWins[winner] >= 11){
    state.phase = "gameover";
    setText("statusPill",`მატჩი დასრულდა — მოიგო მოთამაშე ${winner+1} (${state.matchWins[0]}–${state.matchWins[1]})`);
    render();
    alert(`მატჩი დასრულდა\nმოიგო მოთამაშე ${winner+1}\nსაბოლოო: ${state.matchWins[0]}–${state.matchWins[1]}`);
    return;
  }
  setTimeout(startNewGame, 900);
}

/* ===== NEW GAME ===== */
function startNewGame(){
  state.gamePoints = [0,0];
  state.stake = 1;
  state.pendingOffer = null;
  state.nextRaisePlayer = null;
  state.lockInput = false;

  state.trump = SUITS[Math.floor(Math.random()*SUITS.length)];
  state.deck = buildDeck(); // 36
  state.hands = [[],[]];

  for(let i=0;i<5;i++){
    state.hands[0].push(state.deck.pop());
    state.hands[1].push(state.deck.pop());
  }
  sortHand(state.hands[0], state.trump);
  sortHand(state.hands[1], state.trump);

  resetExchange();
  state.leader = 0;
  state.turn = 0;
  state.phase = "playing";

  setText("statusPill","ახალი თამაში დაიწყო — შენი სვლაა");
  logLine(`— ახალი თამაში. კოზირი: ${state.trump} ${SUIT_SYMBOL[state.trump]}. გემბანში დარჩა: ${state.deck.length}.`);
  render();
}

/* ===== Offers (same logic) ===== */
function showOfferUI({mode, options, incomingLevel}){
  $("offerModal").style.display="flex";
  $("offerButtons").innerHTML="";

  if(mode==="make"){
    setText("offerTitle","შეთავაზების გაკეთება");
    setText("offerText","აირჩიე საფასური. თუ მოთამაშე 2 უარს იტყვის — თამაშს შენ იგებ ავტომატურად.");
    for(const opt of options){
      const b=document.createElement("button");
      b.className="primary";
      b.textContent = raiseLabel(opt);
      b.onclick = ()=>{
        $("offerModal").style.display="none";
        makeOffer(0,1,opt);
      };
      $("offerButtons").append(b);
    }
  } else {
    setText("offerTitle",`მიღებულია შეთავაზება: ${raiseLabel(incomingLevel)}`);
    setText("offerText","დათანხმდი რომ გაგრძელდეს. უარი = თამაშს აგებ ავტომატურად.");
    const accept=document.createElement("button");
    accept.className="primary";
    accept.textContent="დათანხმება";
    accept.onclick=()=>{
      $("offerModal").style.display="none";
      acceptOffer();
    };
    const refuse=document.createElement("button");
    refuse.textContent="უარი";
    refuse.onclick=()=>{
      $("offerModal").style.display="none";
      refuseOffer();
    };
    $("offerButtons").append(accept, refuse);
  }
}
function openOfferModal(){
  if(!(state.phase==="playing" && state.turn===0) || state.lockInput || state.pendingOffer) return;
  if(state.nextRaisePlayer !== null && state.nextRaisePlayer !== 0){
    logLine("ახლა ვერ ზრდი. შემდეგი ზრდა მხოლოდ მოთამაშე 2-ს შეუძლია.");
    return;
  }
  const current = state.stake;
  const options = RAISES.filter(x=>{
    if(current==="WHOLE") return false;
    if(x==="WHOLE") return true;
    return x > current;
  });
  if(!options.length){
    logLine("მაღალი შეთავაზება აღარ არის.");
    return;
  }
  showOfferUI({mode:"make", options});
}
function makeOffer(from,to,level){
  state.pendingOffer = {from,to,level};
  logLine(`მოთამაშე ${from+1} სთავაზობს: ${raiseLabel(level)}.`);
  state.nextRaisePlayer = to;
  render();
  setTimeout(()=>aiRespondToOffer(level), 450);
}
function acceptOffer(){
  if(!state.pendingOffer) return;
  state.stake = state.pendingOffer.level;
  logLine(`შეთავაზება მიღებულია. ახალი საფასური: ${stakeText(state.stake)}.`);
  state.pendingOffer = null;
  render();
}
function refuseOffer(){
  if(!state.pendingOffer) return;
  const offerer = state.pendingOffer.from;
  logLine(`შეთავაზებაზე უარი. მოიგო მოთამაშე ${offerer+1} ავტომატურად.`);
  state.pendingOffer = null;
  endGameWin(offerer, "შეთავაზებაზე უარი");
}
function aiRespondToOffer(level){
  if(!state.pendingOffer) return;

  const hand = state.hands[1];
  const trumpCount = hand.filter(c=>c.s===state.trump).length;
  const highCount = hand.filter(c=>["Ace","10","King","Queen","Jack"].includes(c.r)).length;

  let acceptChance = 0.70;
  if(level===2) acceptChance = 0.82;
  if(level===3) acceptChance = 0.68;
  if(level===4) acceptChance = 0.54;
  if(level===5) acceptChance = 0.42;
  if(level==="WHOLE"){
    acceptChance = (trumpCount>=3 || (trumpCount>=2 && highCount>=3)) ? 0.55 : 0.12;
  }

  if(Math.random() < acceptChance){
    state.stake = level;
    logLine(`მოთამაშე 2 დათანხმდა: ${raiseLabel(level)}.`);
    state.pendingOffer = null;
    render();
    return;
  }
  logLine(`მოთამაშე 2 უარს ამბობს: ${raiseLabel(level)}. შენ იგებ ავტომატურად.`);
  state.pendingOffer = null;
  endGameWin(0, "მოწინააღმდეგემ უარი თქვა");
}
function maybeAiRaise(){
  if(state.pendingOffer) return;
  if(state.nextRaisePlayer !== 1) return;
  if(!(state.phase==="playing" && state.turn===1)) return;

  const current = state.stake;
  const options = RAISES.filter(x=>{
    if(current==="WHOLE") return false;
    if(x==="WHOLE") return true;
    return x > current;
  });
  if(!options.length) return;

  const hand = state.hands[1];
  const trumpCount = hand.filter(c=>c.s===state.trump).length;
  const behind = state.matchWins[1] < state.matchWins[0];

  let desire = 0.08 + (behind ? 0.10 : 0) + (trumpCount>=3 ? 0.12 : 0);
  if(Math.random() > desire) return;

  const pick = options[0];
  state.pendingOffer = {from:1,to:0,level:pick};
  state.nextRaisePlayer = 0;
  logLine(`მოთამაშე 2 სთავაზობს: ${raiseLabel(pick)}.`);
  render();
  showOfferUI({mode:"respond", incomingLevel:pick});
}

/* buttons */
$("new").addEventListener("click", ()=>{
  state.matchWins=[0,0];
  $("log").innerHTML="";
  logLine("ახალი მატჩი დაიწყო. ვინც პირველი მოიგებს 11 თამაშს — იგებს მატჩს.");
  startNewGame();
});
$("reset").addEventListener("click", ()=>{
  Object.assign(state,{
    matchWins:[0,0],
    gamePoints:[0,0],
    stake:1,
    trump:null,
    deck:[],
    hands:[[],[]],
    leader:0,
    turn:0,
    phase:"idle",
    needCount:0,
    plays:[[],[]],
    selectedIdxs:new Set(),
    pendingOffer:null,
    nextRaisePlayer:null,
    lockInput:false
  });
  $("log").innerHTML="";
  setText("statusPill","დააჭირე “ახალი მატჩი”");
  render();
});
$("playBtn").addEventListener("click", humanPlaySelected);
$("clearBtn").addEventListener("click", clearSelection);
$("offerBtn").addEventListener("click", openOfferModal);
$("offerClose").addEventListener("click", ()=> $("offerModal").style.display="none");

$("infoBtn").addEventListener("click", ()=> $("rulesModal").style.display="flex");
$("rulesModal").addEventListener("click", (e)=>{ if(e.target === $("rulesModal")) $("rulesModal").style.display="none"; });
$("rulesClose").addEventListener("click", ()=> $("rulesModal").style.display="none");

/* init */
render();
</script>
</body>
</html>
