<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Trick Points (61) — Web Card Game</title>
    <style>
        :root {
            --bg: #0f5c3a;
            --panel: #0b3d2a;
            --text: #eaf7ef;
            --muted: #b8e2c8;
            --gold: #fbbf24;
            --card: #ffffff;
            --ink: #111827;
            --shadow: 0 10px 30px rgba(0, 0, 0, .25);
            --radius: 18px;
        }

        * {
            box-sizing: border-box
        }

        body {
            margin: 0;
            font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
            background: radial-gradient(1200px 700px at 50% 30%, #167a4e 0%, var(--bg) 55%, #0a3a26 100%);
            color: var(--text);
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        header {
            display: flex;
            gap: 12px;
            align-items: center;
            justify-content: space-between;
            padding: 14px 16px;
            background: rgba(0, 0, 0, .15);
            backdrop-filter: blur(8px);
            border-bottom: 1px solid rgba(255, 255, 255, .08);
        }

        .title {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .title h1 {
            margin: 0;
            font-size: 16px;
            letter-spacing: .2px
        }

        .title .sub {
            font-size: 12px;
            color: var(--muted)
        }

        .controls {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap
        }

        button {
            appearance: none;
            border: 0;
            cursor: pointer;
            padding: 10px 12px;
            border-radius: 999px;
            background: rgba(255, 255, 255, .12);
            color: var(--text);
            font-weight: 600;
            box-shadow: 0 6px 18px rgba(0, 0, 0, .15);
            transition: transform .08s ease, background .12s ease;
        }

        button:hover {
            background: rgba(255, 255, 255, .16)
        }

        button:active {
            transform: translateY(1px)
        }

        button.primary {
            background: rgba(251, 191, 36, .22);
            border: 1px solid rgba(251, 191, 36, .35)
        }

        button.primary:hover {
            background: rgba(251, 191, 36, .28)
        }

        .pill {
            padding: 8px 10px;
            border-radius: 999px;
            background: rgba(0, 0, 0, .18);
            border: 1px solid rgba(255, 255, 255, .08);
            font-size: 12px;
            color: var(--muted);
            display: flex;
            gap: 8px;
            align-items: center;
            white-space: nowrap;
        }

        .pill b {
            color: var(--text)
        }

        main {
            flex: 1;
            display: flex;
            padding: 14px;
            gap: 14px;
            min-height: 0;
        }

        .board {
            flex: 1;
            background: rgba(0, 0, 0, .14);
            border: 1px solid rgba(255, 255, 255, .08);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            position: relative;
            overflow: hidden;
            min-height: 0;
        }

        .side {
            width: 320px;
            background: rgba(0, 0, 0, .14);
            border: 1px solid rgba(255, 255, 255, .08);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 12px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            min-height: 0;
        }

        .log {
            flex: 1;
            background: rgba(0, 0, 0, .18);
            border: 1px solid rgba(255, 255, 255, .06);
            border-radius: 14px;
            padding: 10px;
            overflow: auto;
            font-size: 12px;
            color: var(--muted);
            line-height: 1.45;
        }

        .log .line {
            margin: 0 0 6px
        }

        .hint {
            font-size: 12px;
            color: var(--muted);
            padding: 10px;
            border-radius: 14px;
            border: 1px dashed rgba(255, 255, 255, .18);
            background: rgba(0, 0, 0, .12);
        }

        /* Table layout */
        .table {
            position: absolute;
            inset: 0;
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            grid-template-rows: 140px 1fr 170px;
            gap: 12px;
            padding: 14px;
        }

        .zone {
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, .08);
            background: rgba(0, 0, 0, .10);
            padding: 10px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            min-height: 0;
        }

        .zone .label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
            color: var(--muted);
        }

        .zone .label b {
            color: var(--text)
        }

        .handRow {
            display: flex;
            gap: 8px;
            align-items: center;
            overflow: auto;
            padding-bottom: 2px;
            min-height: 0;
        }

        .handCol {
            display: flex;
            flex-direction: column;
            gap: 8px;
            overflow: auto;
            min-height: 0;
            align-items: center;
            padding-right: 2px;
        }

        /* Cards */
        .card {
            width: 76px;
            height: 110px;
            border-radius: 14px;
            background: var(--card);
            color: var(--ink);
            box-shadow: 0 8px 18px rgba(0, 0, 0, .25);
            border: 2px solid rgba(17, 24, 39, .14);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 8px;
            position: relative;
            flex: 0 0 auto;
            user-select: none;
            transition: transform .12s ease, box-shadow .12s ease, outline .12s ease;
        }

        .card .top {
            display: flex;
            justify-content: space-between;
            font-weight: 800;
            font-size: 12px;
        }

        .card .mid {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 3px;
            flex: 1;
            font-weight: 900;
            font-size: 18px;
        }

        .card .pts {
            font-size: 11px;
            opacity: .7;
            text-align: center;
            padding-bottom: 2px;
            font-weight: 700;
        }

        .card.red {
            color: #b91c1c
        }

        .card.playable {
            outline: 3px solid rgba(251, 191, 36, .7);
            box-shadow: 0 12px 30px rgba(251, 191, 36, .15), 0 10px 20px rgba(0, 0, 0, .25);
            cursor: pointer;
        }

        .card.playable:hover {
            transform: translateY(-2px)
        }

        .card.back {
            background: linear-gradient(135deg, #1e3a8a, #0b1220);
            color: #fff;
            border: 2px solid rgba(255, 255, 255, .18);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 26px;
            font-weight: 900;
            letter-spacing: 1px;
        }

        .center {
            grid-column: 2 / 3;
            grid-row: 2 / 3;
            display: flex;
            flex-direction: column;
            gap: 10px;
            align-items: center;
            justify-content: center;
            border-radius: 24px;
            background: rgba(0, 0, 0, .12);
            border: 2px solid rgba(11, 61, 42, .6);
            box-shadow: inset 0 0 0 2px rgba(255, 255, 255, .05);
        }

        .trickGrid {
            display: grid;
            grid-template-columns: 120px 120px 120px;
            grid-template-rows: 130px 130px 130px;
            gap: 8px;
            place-items: center;
            align-items: center;
            justify-items: center;
        }

        .centerInfo {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: var(--muted);
        }

        .badge {
            padding: 8px 10px;
            border-radius: 999px;
            border: 1px solid rgba(255, 255, 255, .10);
            background: rgba(0, 0, 0, .18);
            display: flex;
            gap: 8px;
            align-items: center;
            white-space: nowrap;
        }

        .badge b {
            color: var(--text)
        }

        footer {
            padding: 10px 14px;
            font-size: 11px;
            color: var(--muted);
            opacity: .95;
        }

        a {
            color: var(--gold);
            text-decoration: none
        }
    </style>
</head>

<body>
    <header>
        <div class="title">
            <h1>Trick Points — Target 61</h1>
            <div class="sub">Ace=11 • 10=10 • King=4 • Queen=3 • Jack=2 • others=0 • Follow suit • No trump</div>
        </div>
        <div class="controls">
            <button class="primary" id="new2">New Game (2 players)</button>
            <button class="primary" id="new4">New Game (4 players)</button>
            <button id="reset">Reset</button>
            <div class="pill"><span>Turn:</span> <b id="turnPill">—</b></div>
            <div class="pill"><span>Led suit:</span> <b id="ledPill">—</b></div>
            <div class="pill"><span>Deck:</span> <b id="deckPill">—</b></div>
        </div>
    </header>

    <main>
        <section class="board">
            <div class="table">
                <!-- Top -->
                <div class="zone" style="grid-column: 1 / 4; grid-row: 1 / 2;">
                    <div class="label"><b id="topLabel">Top</b><span id="topMeta"></span></div>
                    <div class="handRow" id="topHand"></div>
                </div>

                <!-- Left -->
                <div class="zone" style="grid-column: 1 / 2; grid-row: 2 / 3;">
                    <div class="label"><b id="leftLabel">Left</b><span id="leftMeta"></span></div>
                    <div class="handCol" id="leftHand"></div>
                </div>

                <!-- Center -->
                <div class="center">
                    <div class="trickGrid" id="trickArea"></div>
                    <div class="centerInfo">
                        <div class="badge"><span>Score</span> <b id="scorePill">—</b></div>
                        <div class="badge"><span>Leader</span> <b id="leaderPill">—</b></div>
                        <div class="badge"><span>Status</span> <b id="statusPill">Pick 2 or 4 players</b></div>
                    </div>
                </div>

                <!-- Right -->
                <div class="zone" style="grid-column: 3 / 4; grid-row: 2 / 3;">
                    <div class="label"><b id="rightLabel">Right</b><span id="rightMeta"></span></div>
                    <div class="handCol" id="rightHand"></div>
                </div>

                <!-- Bottom (You) -->
                <div class="zone" style="grid-column: 1 / 4; grid-row: 3 / 4;">
                    <div class="label"><b id="bottomLabel">Player 1 (You)</b><span id="bottomMeta"></span></div>
                    <div class="handRow" id="bottomHand"></div>
                </div>
            </div>
        </section>

        <aside class="side">
            <div class="hint" id="hintBox">
                You are Player 1 (bottom). Click a highlighted card to play.<br />
                In 4-player mode: Team A = P1+P3, Team B = P2+P4.
            </div>
            <div class="log" id="log"></div>
        </aside>
    </main>

    <footer>
        Tip: If VS Code “Preview” is blank, open with Live Server or any browser tab. This is a full web app (no
        terminal needed).
    </footer>

    <script>
        /* ----------------------------
           Rules / constants
        ----------------------------- */
        const RANKS = ["6", "7", "8", "9", "Jack", "Queen", "King", "10", "Ace"];
        const SUITS = ["Hearts", "Diamonds", "Clubs", "Spades"];
        const SUIT_SYMBOL = { Hearts: "♥", Diamonds: "♦", Clubs: "♣", Spades: "♠" };

        const POINTS = { Ace: 11, "10": 10, King: 4, Queen: 3, Jack: 2, "9": 0, "8": 0, "7": 0, "6": 0 };
        const STRENGTH = { Ace: 8, "10": 7, King: 6, Queen: 5, Jack: 4, "9": 3, "8": 2, "7": 1, "6": 0 };
        const TARGET = 61;

        const isRedSuit = s => (s === "Hearts" || s === "Diamonds");

        function shuffle(a) {
            for (let i = a.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [a[i], a[j]] = [a[j], a[i]];
            }
            return a;
        }

        function buildDeck() {
            const deck = [];
            for (const s of SUITS) for (const r of RANKS) deck.push({ r, s });
            shuffle(deck);
            return deck;
        }

        function sortHand(hand) {
            const suitOrder = { Hearts: 0, Diamonds: 1, Clubs: 2, Spades: 3 };
            hand.sort((a, b) => {
                const ds = suitOrder[a.s] - suitOrder[b.s];
                if (ds !== 0) return ds;
                return STRENGTH[b.r] - STRENGTH[a.r];
            });
            return hand;
        }

        function cardPoints(c) { return POINTS[c.r] ?? 0; }

        function validMoves(hand, ledSuit) {
            if (!ledSuit) return hand.map((_, i) => i);
            const idxs = [];
            for (let i = 0; i < hand.length; i++) if (hand[i].s === ledSuit) idxs.push(i);
            return idxs.length ? idxs : hand.map((_, i) => i);
        }

        function trickWinner(trick, ledSuit) {
            // trick: [{p, c}]
            const led = trick.filter(x => x.c.s === ledSuit);
            let best = led[0];
            let bestStr = STRENGTH[best.c.r];
            for (const x of led.slice(1)) {
                const st = STRENGTH[x.c.r];
                if (st > bestStr) {
                    best = x;
                    bestStr = st;
                }
            }
            return best.p;
        }

        function trickPoints(trick) {
            return trick.reduce((sum, x) => sum + cardPoints(x.c), 0);
        }

        function teamOf(p) {
            // 4 players: (0,2) vs (1,3)
            return (p === 0 || p === 2) ? 0 : 1;
        }

        function teamName(t) { return t === 0 ? "Team A (P1+P3)" : "Team B (P2+P4)"; }

        /* ----------------------------
           Simple AI
        ----------------------------- */
        function aiChoose(hand, ledSuit, trick) {
            const moves = validMoves(hand, ledSuit);
            const candidates = moves.map(i => ({ i, c: hand[i] }));

            if (!ledSuit) {
                // lead: bias to points
                candidates.sort((a, b) => {
                    const dp = cardPoints(a.c) - cardPoints(b.c);
                    if (dp !== 0) return dp;
                    return STRENGTH[a.c.r] - STRENGTH[b.c.r];
                });
                if (Math.random() < 0.7) return candidates[candidates.length - 1].i;
                return candidates[0].i;
            }

            let currentBest = -1;
            for (const x of trick) if (x.c.s === ledSuit) currentBest = Math.max(currentBest, STRENGTH[x.c.r]);

            const winning = candidates.filter(x => x.c.s === ledSuit && STRENGTH[x.c.r] > currentBest);
            if (winning.length) {
                // cheapest winning
                winning.sort((a, b) => {
                    const dp = cardPoints(a.c) - cardPoints(b.c);
                    if (dp !== 0) return dp;
                    return STRENGTH[a.c.r] - STRENGTH[b.c.r];
                });
                return winning[0].i;
            }

            // dump lowest points
            candidates.sort((a, b) => {
                const dp = cardPoints(a.c) - cardPoints(b.c);
                if (dp !== 0) return dp;
                return STRENGTH[a.c.r] - STRENGTH[b.c.r];
            });
            return candidates[0].i;
        }

        /* ----------------------------
           State
        ----------------------------- */
        const state = {
            numPlayers: null,
            deck: [],
            hands: [],
            scores: [],
            leader: 0,
            order: [],
            pos: 0,
            ledSuit: null,
            trick: [],
            running: false,
            waitingForHuman: false
        };

        /* ----------------------------
           DOM helpers
        ----------------------------- */
        const $ = (id) => document.getElementById(id);

        function logLine(text) {
            const el = document.createElement("div");
            el.className = "line";
            el.textContent = text;
            $("log").prepend(el);
        }

        function clearLog() {
            $("log").innerHTML = "";
        }

        function cardEl(card, { faceUp = true, playable = false, onClick = null } = {}) {
            const d = document.createElement("div");
            d.className = "card";
            if (!faceUp) d.classList.add("back");
            if (playable) d.classList.add("playable");
            if (faceUp && isRedSuit(card.s)) d.classList.add("red");

            if (!faceUp) {
                d.textContent = "★";
                return d;
            }

            const top = document.createElement("div");
            top.className = "top";
            top.innerHTML = `<span>${card.r}</span><span>${SUIT_SYMBOL[card.s]}</span>`;

            const mid = document.createElement("div");
            mid.className = "mid";
            mid.innerHTML = `<div style="font-size:22px">${SUIT_SYMBOL[card.s]}</div><div>${card.r}</div>`;

            const pts = document.createElement("div");
            pts.className = "pts";
            pts.textContent = `${cardPoints(card)} pts`;

            d.append(top, mid, pts);

            if (playable && typeof onClick === "function") {
                d.addEventListener("click", onClick);
            }
            return d;
        }

        function updatePills() {
            $("turnPill").textContent = state.running ? `Player ${state.order[state.pos] + 1}` : "—";
            $("ledPill").textContent = state.ledSuit ? state.ledSuit : "—";
            $("deckPill").textContent = state.running ? String(state.deck.length) : "—";
            $("leaderPill").textContent = state.running ? `Player ${state.leader + 1}` : "—";
            $("scorePill").textContent = state.running ? scoreText() : "—";
        }

        function scoreText() {
            if (state.numPlayers === 2) {
                return `P1 ${state.scores[0]} : ${state.scores[1]} P2`;
            }
            const a = state.scores[0] + state.scores[2];
            const b = state.scores[1] + state.scores[3];
            return `${teamName(0)} ${a} : ${b} ${teamName(1)}`;
        }

        function zoneLabels() {
            if (!state.running) {
                $("topLabel").textContent = "Top";
                $("leftLabel").textContent = "Left";
                $("rightLabel").textContent = "Right";
                return;
            }
            if (state.numPlayers === 2) {
                $("topLabel").textContent = "Player 2";
                $("leftLabel").textContent = "—";
                $("rightLabel").textContent = "—";
            } else {
                $("topLabel").textContent = "Player 3";
                $("leftLabel").textContent = "Player 4";
                $("rightLabel").textContent = "Player 2";
            }
        }

        function render() {
            zoneLabels();
            updatePills();

            // Hands
            const clear = (id) => { $(id).innerHTML = ""; };

            clear("topHand"); clear("leftHand"); clear("rightHand"); clear("bottomHand");
            clear("trickArea");

            if (!state.running) {
                $("statusPill").textContent = "Pick 2 or 4 players";
                return;
            }

            // Top / Left / Right: opponents = backs
            if (state.numPlayers === 2) {
                for (let i = 0; i < state.hands[1].length; i++) {
                    $("topHand").append(cardEl({ r: "", s: "Spades" }, { faceUp: false }));
                }
            } else {
                for (let i = 0; i < state.hands[2].length; i++) {
                    $("topHand").append(cardEl({ r: "", s: "Spades" }, { faceUp: false }));
                }
                for (let i = 0; i < state.hands[3].length; i++) {
                    $("leftHand").append(cardEl({ r: "", s: "Spades" }, { faceUp: false }));
                }
                for (let i = 0; i < state.hands[1].length; i++) {
                    $("rightHand").append(cardEl({ r: "", s: "Spades" }, { faceUp: false }));
                }
            }

            // Human (bottom) face up + playable highlights if human turn
            const hand = state.hands[0];
            const playableIdxs = (state.waitingForHuman && state.order[state.pos] === 0)
                ? new Set(validMoves(hand, state.ledSuit))
                : new Set();

            hand.forEach((c, idx) => {
                const playable = playableIdxs.has(idx);
                $("bottomHand").append(cardEl(c, {
                    faceUp: true,
                    playable,
                    onClick: () => humanPlay(idx)
                }));
            });

            // Trick area (3x3 grid positions)
            const grid = $("trickArea");
            const empty = document.createElement("div");
            empty.style.width = "1px"; empty.style.height = "1px";

            // We map trick cards to approximate table positions:
            // P1 bottom -> row 3 col 2
            // P2 right  -> row 2 col 3
            // P3 top    -> row 1 col 2
            // P4 left   -> row 2 col 1
            const positions = new Map([
                [0, 7], // (row3 col2) index in 0..8
                [1, 5], // (row2 col3)
                [2, 1], // (row1 col2)
                [3, 3], // (row2 col1)
            ]);

            const cells = Array.from({ length: 9 }, () => {
                const cell = document.createElement("div");
                cell.style.width = "120px";
                cell.style.height = "130px";
                cell.style.display = "flex";
                cell.style.alignItems = "center";
                cell.style.justifyContent = "center";
                return cell;
            });

            for (const x of state.trick) {
                const idx = positions.get(x.p) ?? 4;
                cells[idx].append(cardEl(x.c, { faceUp: true }));
            }

            // Center cell show led suit / status
            const center = cells[4];
            const cap = document.createElement("div");
            cap.style.textAlign = "center";
            cap.style.fontSize = "12px";
            cap.style.color = "rgba(234,247,239,.9)";
            cap.innerHTML = state.ledSuit
                ? `Led Suit<br><b style="font-size:18px">${state.ledSuit} ${SUIT_SYMBOL[state.ledSuit]}</b>`
                : `Led Suit<br><b style="font-size:18px">—</b>`;
            center.append(cap);

            cells.forEach(c => grid.append(c));

            // Status
            if (state.waitingForHuman && state.order[state.pos] === 0) {
                $("statusPill").textContent = "Your turn — click a highlighted card";
            } else {
                $("statusPill").textContent = "Playing…";
            }
        }

        /* ----------------------------
           Game flow
        ----------------------------- */
        function startGame(n) {
            state.numPlayers = n;
            state.deck = buildDeck();
            state.hands = Array.from({ length: n }, () => []);
            state.scores = Array.from({ length: n }, () => 0);
            state.leader = 0;
            state.ledSuit = null;
            state.trick = [];
            state.running = true;
            state.waitingForHuman = false;

            clearLog();
            logLine(`New game started with ${n} players.`);
            if (n === 4) logLine(`Teams: ${teamName(0)} vs ${teamName(1)}`);

            // Deal 5 each
            for (let k = 0; k < 5; k++) {
                for (let p = 0; p < n; p++) {
                    state.hands[p].push(state.deck.pop());
                }
            }
            for (let p = 0; p < n; p++) sortHand(state.hands[p]);

            beginTrick();
        }

        function beginTrick() {
            if (!state.running) return;

            if (state.hands.every(h => h.length === 0)) {
                finishGame();
                return;
            }

            state.trick = [];
            state.ledSuit = null;
            state.order = Array.from({ length: state.numPlayers }, (_, i) => (state.leader + i) % state.numPlayers);
            state.pos = 0;

            logLine(`— New trick. Leader: Player ${state.leader + 1}`);
            render();
            advanceTurn();
        }

        function advanceTurn() {
            if (!state.running) return;
            if (checkEnd()) return;

            const p = state.order[state.pos];

            if (p === 0) {
                state.waitingForHuman = true;
                render();
                return;
            }

            state.waitingForHuman = false;
            render();

            // AI plays after a small delay for smoothness
            setTimeout(() => {
                const idx = aiChoose(state.hands[p], state.ledSuit, state.trick);
                playCard(p, idx);
            }, 420);
        }

        function humanPlay(idx) {
            if (!state.running) return;
            const p = state.order[state.pos];
            if (p !== 0) return;
            playCard(0, idx);
        }

        function playCard(player, idx) {
            const hand = state.hands[player];
            const moves = validMoves(hand, state.ledSuit);
            if (!moves.includes(idx)) {
                logLine(`Illegal move by Player ${player + 1} (must follow suit).`);
                return;
            }

            const card = hand.splice(idx, 1)[0];
            if (!state.ledSuit) state.ledSuit = card.s;
            state.trick.push({ p: player, c: card });
            sortHand(hand);

            logLine(`Player ${player + 1} played ${card.r} of ${card.s}.`);

            state.pos += 1;
            render();

            if (state.pos >= state.order.length) {
                resolveTrick();
            } else {
                advanceTurn();
            }
        }

        function resolveTrick() {
            const winner = trickWinner(state.trick, state.ledSuit);
            const pts = trickPoints(state.trick);
            state.scores[winner] += pts;

            logLine(`Trick winner: Player ${winner + 1} (+${pts} points).`);

            state.leader = winner;

            drawAfterTrick(winner);
            render();

            if (checkEnd()) return;

            setTimeout(beginTrick, 900);
        }

        function drawAfterTrick(winner) {
            if (state.deck.length === 0) return;

            const n = state.numPlayers;
            const order = Array.from({ length: n }, (_, i) => (winner + i) % n);

            for (const p of order) {
                if (state.deck.length && state.hands[p].length < 5) {
                    state.hands[p].push(state.deck.pop());
                    sortHand(state.hands[p]);
                }
            }
        }

        function checkEnd() {
            if (!state.running) return false;

            if (state.numPlayers === 2) {
                const p1 = state.scores[0], p2 = state.scores[1];
                if (p1 === 60 && p2 === 60) return finishGame("DRAW (60–60)");
                if (p1 >= TARGET || p2 >= TARGET) return finishGame();
                if (state.hands.every(h => h.length === 0)) return finishGame();
                return false;
            } else {
                const a = state.scores[0] + state.scores[2];
                const b = state.scores[1] + state.scores[3];
                if (a === 60 && b === 60) return finishGame("DRAW (60–60)");
                if (a >= TARGET || b >= TARGET) return finishGame();
                if (state.hands.every(h => h.length === 0)) return finishGame();
                return false;
            }
        }

        function finishGame(forcedResult = null) {
            state.running = false;
            state.waitingForHuman = false;
            render();

            let result = forcedResult;

            if (!result) {
                if (state.numPlayers === 2) {
                    const [p1, p2] = state.scores;
                    if (p1 === 60 && p2 === 60) result = "DRAW (60–60)";
                    else if (p1 >= TARGET && p1 > p2) result = "Player 1 wins!";
                    else if (p2 >= TARGET && p2 > p1) result = "Player 2 wins!";
                    else result = (p1 > p2) ? "Player 1 wins! (higher score)" : (p2 > p1) ? "Player 2 wins! (higher score)" : "DRAW";
                } else {
                    const a = state.scores[0] + state.scores[2];
                    const b = state.scores[1] + state.scores[3];
                    if (a === 60 && b === 60) result = "DRAW (60–60)";
                    else if (a >= TARGET && a > b) result = `${teamName(0)} wins!`;
                    else if (b >= TARGET && b > a) result = `${teamName(1)} wins!`;
                    else result = (a > b) ? `${teamName(0)} wins! (higher score)` : (b > a) ? `${teamName(1)} wins! (higher score)` : "DRAW";
                }
            }

            $("statusPill").textContent = "Game Over";
            logLine(`GAME OVER — ${result}`);
            alert(`${scoreText()}\n\n${result}`);
            return true;
        }

        /* ----------------------------
           UI actions
        ----------------------------- */
        $("new2").addEventListener("click", () => startGame(2));
        $("new4").addEventListener("click", () => startGame(4));
        $("reset").addEventListener("click", () => {
            Object.assign(state, {
                numPlayers: null, deck: [], hands: [], scores: [], leader: 0,
                order: [], pos: 0, ledSuit: null, trick: [], running: false, waitingForHuman: false
            });
            clearLog();
            $("statusPill").textContent = "Pick 2 or 4 players";
            render();
        });

        render();
    </script>
</body>

</html>